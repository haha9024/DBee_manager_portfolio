<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.manager.dbee.dao.log.LogChartDAO">

	<!-- 0. 특정 날짜 테이블이 존재하는지 확인 -->
	<select id="checkLogTableExists" resultType="int">
		SELECT COUNT(*)
		FROM
		information_schema.tables
		WHERE table_schema = #{schema}
		AND table_name
		= #{tableName}
	</select>

	<!-- 로그 테이블의 src_ip 값이 정책 테이블의 src_ip_start~src_ip_end 사이에 있는지 체크하는 메서드 -->
	<!-- <select id="selectLogWithPolicyByDate" resultType="map">
		SELECT l.src_ip, l.p_id, p.name AS policy_name
		FROM ${tableName} l
		JOIN IPS_Policy.Policy p
		ON INET_ATON(l.src_ip) BETWEEN INET_ATON(p.src_ip_start) AND
		INET_ATON(p.src_ip_end)
		WHERE l.detected_dt BETWEEN #{startDate} AND #{endDate}
	</select> -->



	<!-- 1. 특정 날짜의 원하는 시간대 범위별, IP별 통계(국가 기준 top 10) xml (정적 통계) -->
	<!-- 나중에 js든 서비스든 어디에서든 지금이 6시 30분이면 지금까지 쌓인 통계를 보도록 강제하는 처리가 필요하겠군! -->
	<select id="selectTopSrcIpCounts" resultType="map">
		SELECT src_ip, COUNT(*) as cnt
		FROM ${tableName}
		<where>
			detected_dt BETWEEN #{startDate} AND #{endDate}
		</where>
		GROUP BY src_ip
		ORDER BY cnt DESC
	</select>


	<!-- 1.1 특정 날짜의 원하는 시간대 범위별, IP별 통계(국가 기준 top 10) xml (정적 통계), 관리자가 top 
		N 선택 -->
	<select id="selectTopSrcIpCounts2" resultType="map">
		SELECT src_ip, COUNT(*) as cnt
		FROM log_${date}
		<where>
			detected_dt BETWEEN #{startDate} AND #{endDate}
		</where>
		GROUP BY src_ip
		ORDER BY cnt DESC
		LIMIT #{topN}
	</select>


	<!-- 2. 원하는 날짜 기간별 IP 통계 (국가 기준 top 10) xml (동적 통계) -->
	<!-- 날짜 계산, 테이블 목록 준비, 파라미터 구성, 국가별 매핑 수행은 자바에서 한다 -->
	<select id="selectTopCountryCountsByTables" resultType="map"
		parameterType="map">
		SELECT src_ip, COUNT(*) AS cnt
		FROM (
		<foreach collection="tableList" item="tableName"
			separator="UNION ALL">
			SELECT src_ip, detected_dt
			FROM ${tableName}
			WHERE
			detected_dt &gt;= #{startDate}
			AND detected_dt &lt; #{endDate}
		</foreach>
		) AS union_logs
		GROUP BY src_ip
		ORDER BY cnt DESC
		LIMIT 100
	</select>


	<!-- 국가별 top 10은 1, 2번 쿼리로 한다 아래는 1,2 백엔드, 프론트엔드까지 하고 제대로 됐나 체크한다 -->

	<!-- 3. 특정 날짜의 원하는 시간대 범위별 p_id 위반 top 10 -->
	<select id="selectTopPid" resultType="map">
		select p_id, count(*) as cnt
		from ${tableName}
		<where>
			detected_dt between #{startDate} and #{endDate}
		</where>
		group by p_id
		order by cnt DESC
		limit 10
	</select>


	<!-- 시간대별 탐지 수 (1시간 단위), 이미 기록된 데이터만 조회 -->
	<select id="selectHourlyStats" resultType="map">
		SELECT
		DATE_FORMAT(detected_dt, '%Y-%m-%d %H:00:00') AS hour,
		COUNT(*)
		AS cnt
		FROM log_${date}
		<where>
			detected_dt BETWEEN #{startDate} AND #{endDate}
		</where>
		GROUP BY hour
		ORDER BY hour
	</select>

	<!-- 시간대별 탐지 수 (2시간 단위), 이미 기록된 데이터만 조회(확정통계) -->
	<!-- FLOOR(5.7)=5, LPAD(str, len, pad_char)은 str을 왼쪽에 pad_char를 str의 길이가 
		len이 될 때까지 넣음 -->
	<select id="selectTwoHourStats" resultType="map">
		SELECT
		CONCAT(
		DATE_FORMAT(detected_dt, '%Y-%m-%d '),
		LPAD(FLOOR(HOUR(detected_dt) / 2) * 2, 2, '0'),
		':00:00'
		) AS
		two_hour_block,
		COUNT(*) AS cnt
		FROM log_${date}
		<where>
			detected_dt BETWEEN #{startDate} AND #{endDate}
		</where>
		GROUP BY two_hour_block
		ORDER BY two_hour_block
	</select>


	<!-- 정책 타입별 탐지 건수 통계 -->
	<select id="selectPolicyTypeStats" resultType="map">
		SELECT
		policy_type,
		COUNT(*) as cnt
		FROM log_${date}
		<where>
			detected_dt BETWEEN #{startDate} AND #{endDate}
		</where>
		GROUP BY policy_type
	</select>

	<!-- 위험도(LOW, MEDIUM, HIGH, CRITICAL)별 탐지 건수 통계 -->
	<select id="selectThreatLevelStats" resultType="map">
		SELECT
		threat_level,
		COUNT(*) as cnt
		FROM log_${date}
		<where>
			detected_dt BETWEEN #{startDate} AND #{endDate}
		</where>
		GROUP BY threat_level
	</select>

</mapper>