<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.manager.dbee.dao.policy.PolicyDAO">

	<!-- 1. 전체 정책 조회 -->
	<select id="selectAllPolicies"
		resultType="com.manager.dbee.dto.Policy">
		SELECT * FROM Policy
	</select>

	<!-- 1.1 전체 정책 조회(페이지네이션1) -->
	<select id="selectSomePolicies"
		resultType="com.manager.dbee.dto.Policy">
		select * from Policy
		limit ${pageLimit} offset ${pageOffset}
	</select>

	<!-- 1.2 정책 테이블의 건수(row) 조회 -->
	<select id="getPoliciesCnt" resultType="int">
		select count(*) from
		Policy;
	</select>


	<!-- 1.3 정책 목록 조회 (페이지네이션, 등록일/수정일 필터 적용, 정책타입 필터 적용) -->
	<select id="selectPoliciesWithFilterAndPagination"
		resultType="com.manager.dbee.dto.Policy">
		select * from Policy
		<where>
			<if test="typeFilter != null and typeFilter !=''">
				policy_type = #{typeFilter}	<!-- 이 줄이 필수, 필터 적용 -->
			</if>
		</where>
		order by
		<choose>
			<when test="orderBy.equals('created_at')">created_at</when>
			<when test="orderBy.equals('updated_at')">updated_at</when>
			<otherwise>p_id</otherwise>
		</choose>
		<choose>
			<when test="direction.equalsIgnoreCase('desc')">DESC</when>
			<otherwise>ASC</otherwise>
		</choose>
		LIMIT #{viewCnt} OFFSET #{offset}
	</select>


	<!-- 1.4 정책 건수 조회 (정책타입 필터 적용) -->
	<select id="countPoliciesWithFilter" resultType="int">
		SELECT COUNT(*) FROM Policy
		<where>
			<if test="typeFilter != null and typeFilter != ''">
				policy_type = #{typeFilter}
			</if>
		</where>
	</select>



	<!-- 2. 단일 정책 조회 (ID로) -->
	<select id="selectPolicyById" parameterType="string"
		resultType="com.manager.dbee.dto.Policy">
		SELECT * FROM Policy WHERE p_id = #{p_id}
	</select>

	<!-- 0614 2.1 함수 추가 -->
	<!-- 2.1 단일 정책 조회(name으로) -->
	<select id="selectPolicyByName" parameterType="string"
		resultType="com.manager.dbee.dto.Policy">
		SELECT * FROM Policy WHERE name = #{name}
	</select>


	<!-- 3. 고급 정책 검색 쿼리 UI의 필터 조건과 일대일 매핑되며, 각 항목별로 조건 방식 반영 -->
	<select id="searchPoliciesAdvanced"
		resultType="com.manager.dbee.dto.Policy" parameterType="map">
		SELECT * FROM Policy
		<where>

			<!-- 정책 ID (정확 일치) -->
			<if test="p_id != null and p_id != ''">
				AND p_id = #{p_id}
			</if>


			<!-- 정책 이름 (LIKE 검색) -->
			<if test="name != null and name != ''">
				AND name LIKE CONCAT('%', #{name}, '%')
			</if>


			<!-- 상태 선택 (단일 선택) -->

			<if test="status != null and status != ''">
				AND status = #{status}
			</if>


			<!-- 정책 타입 선택 (단일 선택) -->
			<if test="policy_type != null and policy_type != ''">
				AND policy_type = #{policy_type}
			</if>


			<!-- 위협 레벨 다중 선택 (enum IN) -->
			<if test="threat_levels != null and threat_levels.size() > 0">
				AND threat_level IN
				<foreach item="tl" collection="threat_levels" open="("
					separator="," close=")">
					#{tl}
				</foreach>
			</if>


			<!-- action_to_take 다중 액션 필터: 모두 포함하는 조건 (LIKE AND LIKE...) -->
			<if
				test="action_to_take_list != null and action_to_take_list.size() > 0">
				<trim prefix="AND (" suffix=")" suffixOverrides="OR">
					<foreach item="act" collection="action_to_take_list"
						separator="OR">
						action_to_take LIKE CONCAT('%', #{act}, '%')
					</foreach>
				</trim>
			</if>



			<!-- base_sec: 숫자 또는 범위 검색 -->
			<if
				test="min_base_sec != null and min_base_sec != '' and max_base_sec != null and max_base_sec != ''">
				AND ( base_sec BETWEEN #{min_base_sec} AND #{max_base_sec} OR base_sec IS NULL )
			</if>
			<if
				test="min_base_sec != null and min_base_sec != '' and (max_base_sec == null or max_base_sec == '')">
				AND ( base_sec &gt;= #{min_base_sec} OR base_sec IS NULL )
			</if>
			<if
				test="max_base_sec != null and max_base_sec != '' and (min_base_sec == null or min_base_sec == '')">
				AND ( base_sec &lt;= #{max_base_sec} OR base_sec IS NULL )
			</if>


			<!-- base_count: 숫자 또는 범위 검색 -->
			<if
				test="min_base_count != null and min_base_count != '' and max_base_count != null and max_base_count != ''">
				AND ( base_count BETWEEN #{min_base_count} AND #{max_base_count} OR base_count IS NULL )
			</if>
			<if
				test="min_base_count != null and min_base_count != '' and (max_base_count == null or max_base_count == '')">
				AND ( base_count &gt;= #{min_base_count} OR base_count IS NULL )
			</if>
			<if
				test="max_base_count != null and max_base_count != '' and (min_base_count == null or min_base_count == '')">
				AND ( base_count &lt;= #{max_base_count} OR base_count IS NULL )
			</if>


			<!-- 등록자 또는 수정자 체크박스 선택 (OR 조건) -->
			<if test="created_by_list != null and created_by_list.size() > 0">
				AND created_by IN
				<foreach item="cb" collection="created_by_list" open="("
					separator="," close=")">
					#{cb}
				</foreach>
			</if>
			<if test="updated_by_list != null and updated_by_list.size() > 0">
				OR updated_by IN
				<foreach item="ub" collection="updated_by_list" open="("
					separator="," close=")">
					#{ub}
				</foreach>
			</if>

			<!-- created_at 생성일 범위 검색 -->
			<if test="start_created_at != null and end_created_at != null">
				AND created_at BETWEEN #{start_created_at} AND
				#{end_created_at}
			</if>


			<!-- updated_at 수정일 범위 검색 -->
			<if test="start_updated_at != null and end_updated_at != null">
				AND updated_at BETWEEN #{start_updated_at} AND
				#{end_updated_at}
			</if>

			<!-- 0704 추가: base_count: 숫자 또는 범위 검색 -->
			<if
				test="min_block_duration != null and min_block_duration != '' and max_block_duration != null and max_block_duration != ''">
				AND ( block_duration BETWEEN #{min_block_duration} AND
				#{max_block_duration} OR `block_duration(sec)` IS NULL )
			</if>
			
			<!-- 아래 주석이 안 된 건 block_duration이라고만 검색해서 그렇다 백틱으로 감싸고 (sec)을 넣어야 sql 필드명과 완벽히 일치한다 -->
			<!-- <if test="min_block_duration != null and min_block_duration != '' 
				and (max_block_duration == null or max_block_duration == '')"> AND block_duration 
				&gt;= #{min_block_duration} </if> <if test="max_block_duration != null and 
				max_block_duration != '' and (min_block_duration == null or min_block_duration 
				== '')"> AND block_duration &lt;= #{max_block_duration} </if> -->
				
			<!-- 최소만 있을 때 -->
			<if test="min_block_duration != null and min_block_duration != ''">
				AND ( `block_duration(sec)` &gt;= #{min_block_duration} OR `block_duration(sec)` IS NULL )
			</if>
			<!-- 최대만 있을 때 -->
			<if test="max_block_duration != null and max_block_duration != ''">
				AND ( `block_duration(sec)` &lt;= #{max_block_duration} OR `block_duration(sec)` IS NULL )
			</if>
		</where>
		ORDER BY updated_at DESC
	</select>

	<!-- p_id, name, status, created_by, updated_by, created_at, updated_at, 
		policy_type, threat_level, action_to_take -->

	<!-- status, policy_type, created_by, base_sec -->

	<!-- 정책 등록 (동적 INSERT) -->
	<insert id="insertPolicy"
		parameterType="com.manager.dbee.dto.Policy">
		INSERT INTO Policy
		<trim prefix="(" suffix=")" suffixOverrides=",">
			p_id,
			name,
			<if test="status != null">status,</if>
			<if test="description != null">description,</if>
			<if test="created_by != null">created_by,</if>
			<if test="updated_by != null">updated_by,</if>
			<if test="base_sec != null">base_sec,</if>
			<if test="base_count != null">base_count,</if>
			<if test="src_ip_start != null">src_ip_start,</if>
			<if test="src_ip_end != null">src_ip_end,</if>
			<if test="dst_ip_start != null">dst_ip_start,</if>
			<if test="dst_ip_end != null">dst_ip_end,</if>
			<if test="dst_port_start != null">dst_port_start,</if>
			<if test="dst_port_end != null">dst_port_end,</if>
			<if test="payload_content1 != null">payload_content1,</if>
			<if test="payload_content2 != null">payload_content2,</if>
			<if test="payload_content3 != null">payload_content3,</if>
			created_at,
			updated_at,
			<if test="policy_type != null">policy_type,</if>
			<if test="threat_level != null">threat_level,</if>
			action_to_take,
			<if test="block_duration != null">`block_duration(sec)`</if>
		</trim>
		<trim prefix="VALUES (" suffix=")" suffixOverrides=",">
			#{p_id},
			#{name},
			<if test="status != null">#{status},</if>
			<if test="description != null">#{description},</if>
			<if test="created_by != null">#{created_by},</if>
			<if test="updated_by != null">#{updated_by},</if>
			<if test="base_sec != null">#{base_sec},</if>
			<if test="base_count != null">#{base_count},</if>
			<if test="src_ip_start != null">#{src_ip_start},</if>
			<if test="src_ip_end != null">#{src_ip_end},</if>
			<if test="dst_ip_start != null">#{dst_ip_start},</if>
			<if test="dst_ip_end != null">#{dst_ip_end},</if>
			<if test="dst_port_start != null">#{dst_port_start},</if>
			<if test="dst_port_end != null">#{dst_port_end},</if>
			<if test="payload_content1 != null">#{payload_content1},</if>
			<if test="payload_content2 != null">#{payload_content2},</if>
			<if test="payload_content3 != null">#{payload_content3},</if>
			NOW(),
			NOW(),
			<if test="policy_type != null">#{policy_type},</if>
			<if test="threat_level != null">#{threat_level},</if>
			#{action_to_take},
			<if test="block_duration != null">#{block_duration}</if>
		</trim>
	</insert>


</mapper>
